#!/bin/bash
#
# Git commit-msg hook: Validate commit message format and enforce file requirements
#
# This hook ensures:
# 1. Commit messages follow conventional format
# 2. Required tracking files are included for specific commit types
# 3. Protocol requirements are met
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

echo "üîç Validating commit message..."

# Get first line (subject)
SUBJECT=$(echo "$COMMIT_MSG" | head -n 1)

# Skip validation for merge commits
if echo "$SUBJECT" | grep -q "^Merge"; then
    echo -e "${GREEN}‚úì Merge commit detected, skipping validation${NC}"
    exit 0
fi

# Skip validation for revert commits
if echo "$SUBJECT" | grep -q "^Revert"; then
    echo -e "${GREEN}‚úì Revert commit detected, skipping validation${NC}"
    exit 0
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Function to check if file is staged
is_staged() {
    echo "$STAGED_FILES" | grep -q "^$1$"
}

# Function to check conventional commit format
validate_conventional_format() {
    # Pattern: type(scope): subject
    # OR: type: subject
    if ! echo "$SUBJECT" | grep -qE '^(feat|fix|docs|chore|refactor|test|perf|ci|build|style|wip)(\(.+\))?: .+'; then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: Commit message doesn't follow conventional format${NC}"
        echo -e "${YELLOW}   Expected: type(scope): subject${NC}"
        echo -e "${YELLOW}   Example: feat(auth): add login functionality${NC}"
        echo -e "${YELLOW}   Types: feat, fix, docs, chore, refactor, test, perf, ci, build, style, wip${NC}"
        echo ""
        echo -e "${YELLOW}   Your message: $SUBJECT${NC}"
        echo ""
        # Warning only, don't block
        return 0
    fi
}

# Validate conventional format
validate_conventional_format

# Check for specific commit patterns and enforce file requirements

# Pattern 1: "chore: Start [task]" requires TODO.md
if echo "$SUBJECT" | grep -qiE '^chore.*: (start|begin)'; then
    echo "üîç Detected task start commit..."

    if ! is_staged "TODO.md"; then
        echo -e "${RED}‚ùå ERROR: Task start commit requires TODO.md${NC}"
        echo -e "${RED}   Message: $SUBJECT${NC}"
        echo -e "${RED}   Protocol 2: Must update TODO.md when starting a task${NC}"
        echo -e "${RED}   Fix: git add TODO.md${NC}"
        exit 1
    fi

    echo -e "${GREEN}‚úì TODO.md is staged${NC}"
fi

# Pattern 2: "chore: Complete [task]" requires TODO.md
if echo "$SUBJECT" | grep -qiE '^chore.*: complete'; then
    echo "üîç Detected task completion commit..."

    if ! is_staged "TODO.md"; then
        echo -e "${RED}‚ùå ERROR: Task completion commit requires TODO.md${NC}"
        echo -e "${RED}   Message: $SUBJECT${NC}"
        echo -e "${RED}   Protocol 4: Must update TODO.md when completing a task${NC}"
        echo -e "${RED}   Fix: git add TODO.md${NC}"
        exit 1
    fi

    echo -e "${GREEN}‚úì TODO.md is staged${NC}"
fi

# Pattern 3: "docs: Add ADR-XXX" requires DECISIONS.md
if echo "$SUBJECT" | grep -qE '^docs.*: (add|create).*ADR-[0-9]+'; then
    echo "üîç Detected ADR commit..."

    if ! is_staged "DECISIONS.md"; then
        echo -e "${RED}‚ùå ERROR: ADR commit requires DECISIONS.md${NC}"
        echo -e "${RED}   Message: $SUBJECT${NC}"
        echo -e "${RED}   Protocol 3: Must update DECISIONS.md when documenting decisions${NC}"
        echo -e "${RED}   Fix: git add DECISIONS.md${NC}"
        exit 1
    fi

    echo -e "${GREEN}‚úì DECISIONS.md is staged${NC}"
fi

# Pattern 4: "docs: Update changelog for Phase X" requires CHANGELOG.md
if echo "$SUBJECT" | grep -qiE '^docs.*: update changelog.*phase'; then
    echo "üîç Detected changelog update commit..."

    if ! is_staged "CHANGELOG.md"; then
        echo -e "${RED}‚ùå ERROR: Changelog update commit requires CHANGELOG.md${NC}"
        echo -e "${RED}   Message: $SUBJECT${NC}"
        echo -e "${RED}   Protocol 5: Must stage CHANGELOG.md for changelog updates${NC}"
        echo -e "${RED}   Fix: git add CHANGELOG.md${NC}"
        exit 1
    fi

    echo -e "${GREEN}‚úì CHANGELOG.md is staged${NC}"
fi

# Pattern 5: "docs: Update status for Phase X" requires STATUS.md
if echo "$SUBJECT" | grep -qiE '^docs.*: update status.*phase'; then
    echo "üîç Detected STATUS.md update commit..."

    if ! is_staged "STATUS.md"; then
        echo -e "${RED}‚ùå ERROR: Status update commit requires STATUS.md${NC}"
        echo -e "${RED}   Message: $SUBJECT${NC}"
        echo -e "${RED}   Protocol 5: Must stage STATUS.md for status updates${NC}"
        echo -e "${RED}   Fix: git add STATUS.md${NC}"
        exit 1
    fi

    echo -e "${GREEN}‚úì STATUS.md is staged${NC}"
fi

# Pattern 6: Phase completion (contains "Phase X:" or "Phase-X") should have all 4 files
if echo "$SUBJECT" | grep -qiE 'phase[ -][0-9]+:'; then
    echo "üîç Detected phase-related commit..."

    # Check if this is a phase completion (not just phase work)
    if echo "$SUBJECT" | grep -qiE '(complete|finish|done)'; then
        echo "üîç This looks like a phase completion commit..."

        MISSING_FILES=""

        if ! is_staged "CHANGELOG.md"; then
            MISSING_FILES="$MISSING_FILES CHANGELOG.md"
        fi
        if ! is_staged "STATUS.md"; then
            MISSING_FILES="$MISSING_FILES STATUS.md"
        fi
        if ! is_staged "CLAUDE.md"; then
            MISSING_FILES="$MISSING_FILES CLAUDE.md"
        fi
        if ! is_staged "TODO.md"; then
            MISSING_FILES="$MISSING_FILES TODO.md"
        fi

        if [ -n "$MISSING_FILES" ]; then
            echo -e "${RED}‚ùå ERROR: Phase completion requires all 4 tracking files${NC}"
            echo -e "${RED}   Message: $SUBJECT${NC}"
            echo -e "${RED}   Missing:$MISSING_FILES${NC}"
            echo -e "${RED}   Protocol 5: Phase completion requires CHANGELOG.md, STATUS.md, CLAUDE.md, TODO.md${NC}"
            echo -e "${RED}   Fix: git add <missing files>${NC}"
            exit 1
        fi

        echo -e "${GREEN}‚úì All 4 tracking files are staged${NC}"
    fi
fi

# Check message length (subject should be ‚â§72 characters)
SUBJECT_LENGTH=${#SUBJECT}
if [ $SUBJECT_LENGTH -gt 72 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Commit subject is $SUBJECT_LENGTH characters (recommended: ‚â§72)${NC}"
    echo -e "${YELLOW}   Consider shortening for better readability in git log${NC}"
    echo ""
fi

echo -e "${GREEN}‚úÖ Commit message validation passed${NC}"
echo ""

exit 0
