#!/bin/bash
#
# Git pre-commit hook: Enforce workflow documentation
#
# This hook validates that tracking files (TODO.md, STATUS.md, DECISIONS.md, CHANGELOG.md)
# are properly updated when committing changes.
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "üîç Running pre-commit workflow validation..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if code files are being committed
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '^(app|components|lib)/.*\.(tsx?|jsx?|css)$' || true)
DOC_FILES=$(echo "$STAGED_FILES" | grep -E '\.(md)$' || true)

# Function to check if file is staged
is_staged() {
    echo "$STAGED_FILES" | grep -q "^$1$"
}

# Function to check if timestamp in file is recent (within last 2 hours)
check_timestamp() {
    local file=$1
    local file_name=$(basename "$file")

    if [ ! -f "$file" ]; then
        return 0  # File doesn't exist, skip check
    fi

    # Extract timestamp from file (format: YYYY-MM-DD HH:MM UTC)
    local timestamp=$(grep -m 1 "Last Updated:" "$file" | sed -E 's/.*Last Updated.*: ([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}).*/\1/')

    if [ -z "$timestamp" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: Could not find 'Last Updated:' timestamp in $file_name${NC}"
        return 0  # Don't block commit, just warn
    fi

    # Convert timestamp to seconds since epoch (portable version)
    local timestamp_seconds=$(date -j -f "%Y-%m-%d %H:%M" "$timestamp" "+%s" 2>/dev/null || echo "0")
    local current_seconds=$(date "+%s")
    local diff=$((current_seconds - timestamp_seconds))
    local two_hours=$((2 * 60 * 60))

    if [ $diff -gt $two_hours ] && [ $timestamp_seconds -ne 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: $file_name timestamp is older than 2 hours${NC}"
        echo -e "${YELLOW}   Last updated: $timestamp UTC${NC}"
        echo -e "${YELLOW}   Consider updating the timestamp if you modified this file${NC}"
    fi
}

# Function to validate TODO.md format
validate_todo() {
    if [ ! -f "TODO.md" ]; then
        return 0
    fi

    # Check that "In Progress" section has at most 1 item
    local in_progress_count=$(sed -n '/^## üî• In Progress/,/^##/p' TODO.md | grep -c '^\- \[ \]' || echo "0")

    if [ "$in_progress_count" -gt 1 ]; then
        echo -e "${RED}‚ùå ERROR: TODO.md has $in_progress_count tasks in 'In Progress' section${NC}"
        echo -e "${RED}   RULE: Only 1 task allowed in 'In Progress' at a time${NC}"
        echo -e "${RED}   Fix: Move extra tasks to 'Up Next' or mark as completed${NC}"
        return 1
    fi
}

# Check 1: Validate TODO.md format if it's staged
if is_staged "TODO.md"; then
    echo "‚úÖ Checking TODO.md format..."
    if ! validate_todo; then
        exit 1
    fi
    check_timestamp "TODO.md"
fi

# Check 2: Validate STATUS.md timestamp if it's staged
if is_staged "STATUS.md"; then
    echo "‚úÖ Checking STATUS.md timestamp..."
    check_timestamp "STATUS.md"
fi

# Check 3: If code files changed, recommend updating TODO.md
if [ -n "$CODE_FILES" ] && ! is_staged "TODO.md"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Code files changed but TODO.md not staged${NC}"
    echo -e "${YELLOW}   Changed files:${NC}"
    echo "$CODE_FILES" | sed 's/^/     - /'
    echo -e "${YELLOW}   Recommendation: Update TODO.md if starting/completing a task${NC}"
    echo ""
fi

# Check 4: If committing documentation, check for phase completion pattern
if echo "$STAGED_FILES" | grep -q "CLAUDE.md"; then
    # Check if this looks like a phase completion
    if git diff --cached CLAUDE.md | grep -q "Phase.*Completed"; then
        echo "üîç Detected potential phase completion in CLAUDE.md..."

        # Verify all 4 tracking files are staged
        MISSING_FILES=""

        if ! is_staged "CHANGELOG.md"; then
            MISSING_FILES="$MISSING_FILES CHANGELOG.md"
        fi
        if ! is_staged "STATUS.md"; then
            MISSING_FILES="$MISSING_FILES STATUS.md"
        fi
        if ! is_staged "TODO.md"; then
            MISSING_FILES="$MISSING_FILES TODO.md"
        fi

        if [ -n "$MISSING_FILES" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  Warning: Phase completion detected but missing files:${NC}"
            echo -e "${YELLOW}  $MISSING_FILES${NC}"
            echo -e "${YELLOW}   Protocol 5 requires: CHANGELOG.md, STATUS.md, CLAUDE.md, TODO.md${NC}"
            echo ""
        fi
    fi
fi

# Check 5: If DECISIONS.md is staged, verify it has a recent ADR
if is_staged "DECISIONS.md"; then
    echo "‚úÖ Checking DECISIONS.md for new ADR..."

    # Check if there's a new ADR in the diff
    if git diff --cached DECISIONS.md | grep -q "^+## ADR-"; then
        echo -e "${GREEN}‚úì New ADR detected in DECISIONS.md${NC}"
    fi

    check_timestamp "DECISIONS.md"
fi

# Check 6: Detect conventional commit keywords in staged files
if is_staged "TODO.md"; then
    # Check if this is a task start/completion
    if git diff --cached TODO.md | grep -q "In Progress"; then
        echo -e "${GREEN}‚úì TODO.md update detected (task start/completion)${NC}"
    fi
fi

echo -e "${GREEN}‚úÖ Pre-commit validation passed${NC}"
echo ""

# Run lint-staged for automatic formatting and linting of staged files
echo "üîß Running lint-staged on changed files..."
if command -v pnpm &> /dev/null; then
    if pnpm lint-staged; then
        echo -e "${GREEN}‚úÖ Lint-staged completed successfully${NC}"
    else
        echo -e "${RED}‚ùå Lint-staged failed. Please fix the issues above.${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  pnpm not found, skipping lint-staged${NC}"
fi

echo ""
exit 0
