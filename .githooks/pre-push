#!/bin/bash
#
# Git pre-push hook: Run comprehensive validation before pushing
#
# This hook runs build and test validation before allowing push.
# For TDD workflow, these are more expensive operations that we don't
# want to run on every commit.
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${BLUE}üöÄ Running pre-push validation...${NC}"
echo ""

# Function to run command with nice output
run_check() {
    local name=$1
    local cmd=$2

    echo -e "${CYAN}‚ñ∂ Running ${name}...${NC}"

    if eval "$cmd"; then
        echo -e "${GREEN}‚úÖ ${name} passed${NC}"
        echo ""
        return 0
    else
        echo -e "${RED}‚ùå ${name} failed${NC}"
        echo -e "${RED}   Fix the issues above before pushing${NC}"
        return 1
    fi
}

# Check 1: Quick validation (lint, type-check, format)
echo -e "${BLUE}=== Phase 1: Quick Checks ===${NC}"
if ! run_check "Quick validation" "pnpm validate:quick"; then
    exit 1
fi

# Check 2: Build validation
echo -e "${BLUE}=== Phase 2: Build ===${NC}"
if ! run_check "Production build" "pnpm build"; then
    exit 1
fi

# Check 3: Test with coverage
echo -e "${BLUE}=== Phase 3: Tests ===${NC}"
if ! run_check "Unit tests with coverage" "pnpm test:coverage"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Coverage thresholds not met. Check coverage report for details.${NC}"
    echo -e "${YELLOW}   Run 'pnpm coverage:report' to see detailed coverage${NC}"

    # Ask if they want to push anyway
    echo -e "${YELLOW}Do you want to push anyway? (y/N):${NC}"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Optional: Run E2E tests (can be slow, so make it optional)
echo -e "${BLUE}=== Optional: E2E Tests ===${NC}"
echo -e "${CYAN}Run E2E tests before pushing? This will test on all viewports. (y/N):${NC}"
read -r response
if [[ "$response" =~ ^[Yy]$ ]]; then
    if ! run_check "E2E tests (all viewports)" "pnpm test:viewports"; then
        echo -e "${YELLOW}‚ö†Ô∏è  E2E tests failed. Check the output above.${NC}"
        echo -e "${YELLOW}Push anyway? (y/N):${NC}"
        read -r response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

# Optional: Run accessibility tests
echo -e "${CYAN}Run accessibility tests? (y/N):${NC}"
read -r response
if [[ "$response" =~ ^[Yy]$ ]]; then
    if ! run_check "Accessibility tests" "pnpm test:a11y:all"; then
        echo -e "${YELLOW}‚ö†Ô∏è  Accessibility tests failed. Check the output above.${NC}"
        echo -e "${YELLOW}Push anyway? (y/N):${NC}"
        read -r response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

echo -e "${GREEN}‚úÖ All pre-push validations passed!${NC}"
echo -e "${GREEN}üöÄ Ready to push to remote${NC}"
echo ""

exit 0